---
title: "iNaturalist Data Analysis"
output: html_document
date: "2023-11-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{R Load Data}
river_res <- read.csv("river_res.csv")
sam_res <- read.csv("sam_res.csv")
nam_res <- read.csv("nam_res.csv")
nz_res <- read.csv("nz_res.csv")
bz_res <- read.csv("bz_res.csv")
batch2_res <- read.csv("batch2_res.csv")
batch3_res <- read.csv("batch3_res.csv")
```

Relevant libraries are invoked.

```{r Libraries}
library(dplyr)
library(tidyr)
library(ggplot2)
library(gapminder)
library(gganimate)
library(gifski)
#library(dummies)
library(tidyverse)
library(viridis)
library(maps)
library(arules)
```

First, I will examine the timing of sightings of size zero specimen, which are assumed to be babies. The first attempt will make an animated map showing the appearence of size zero specimen over the course of the year. 

Each data set is combined into a single data frame with only the values from the "body_size" column extracted.
```{r DF}
offset <- 60
mapWorld <- map_data('world', wrap=c(offset, offset+360), ylim=c(-55,75))
theme_set(theme_classic())
all_results_babies <- bind_rows(river_res,sam_res,nam_res,nz_res,bz_res,batch2_res,batch3_res) %>% mutate(lon_off = ifelse(longitude < offset, longitude + 360, longitude), trait = body_size) %>% select(id,trait,lon_off,longitude,latitude,place_country_name,observed_on)
summary(all_results_babies)
```

First a static map of size zero specimen is created.

```{r Map 0}
g2 <- ggplot() + geom_polygon(data = mapWorld, aes(x=long, y = lat, group = group), fill = "light gray") + geom_point(data = all_results_babies,aes(x = lon_off, y = latitude), color = "black", alpha = 0.5, size = 1, pch = 16) + geom_point(data = all_results_babies %>% filter(trait == "0"), aes(x = lon_off, y = latitude, group = id), color = "dark orange", alpha = 1, size = 3, pch = 16) + theme(axis.text.x = element_blank(), axis.text.y = element_blank()) + ylab("") + xlab("")
g2
```

Now I will examine the time dependence of the appearance of babies. First, I need to extract only the month from the date string.

```{r Month Date}
all_results_babies$observed_on <- substr(all_results_babies$observed_on, 6, 7)
```

I will animate the data to observe the trend over time.

```{r Animation}
p2 <- ggplot() + geom_polygon(data = mapWorld, aes(x = long, y = lat, group = group), fill = "light gray") + geom_point(data = all_results_babies %>% filter(trait == "0"), aes(x = lon_off, y = latitude, group = id), color = "dark orange", alpha = 1, size = 3, pch = 16) + theme(axis.text.x = element_blank(), axis.text.y = element_blank()) + ylab("") + xlab("") + labs(title = 'Month: {closest_state}') + transition_states(observed_on, transition_length = 2, state_length = 2) + ease_aes('linear')
animate(p2)
```

Now I want to see the trend in appearances in a more quantitative way.

First I want to split the data into the Northern and Southern Hemisphere after doing some data cleaning.

```{r Hemisphere Split}
all_results_babies <- all_results_babies %>% mutate(hemisphere = ifelse(latitude >= 0 & !is.na(latitude), "Northern", ifelse(latitude < 0 & !is.na(latitude), "Southern", NA)))
summary(all_results_babies)
```

Now looking at the trend.

```{r Trends}
ggplot(all_results_babies %>% filter(trait == "0"), aes(x = as.factor(observed_on))) + geom_line(stat = "count", aes(group = 1), color = "blue") + geom_point(stat = "count", aes(y = ..count..), color = "red") + labs(x = "Month", t = "Number of Occurences", title = "Distribution of Size 0 Specimen Over the Year") + facet_wrap(~ hemisphere, scales = "free_y") + theme_minimal()
```

Now I am going to do some Association Rules Mining. First lets put all of the data into a single data frame.

```{r Preprocessing}
all_results <- bind_rows(river_res, sam_res, nam_res, nz_res, bz_res, batch2_res, batch3_res) %>% mutate(lon_off = ifelse(longitude < offset, longitude + 360, longitude)) %>% select(id, body_size, handedness, tentacle_number, crest_height, thumb_ratio, pink_purple, clear, body_color, gap, gonodendra, latitude, longitude, observed_on, place_country_name)
```

Now the whole data frame needs to be converted to binary for the association rule mining to work best.
```{r Binary}
all_results <- all_results %>% mutate(body_color_Y = ifelse(body_color == "Y", 1, 0))
all_results <- all_results %>% mutate(body_color_R = ifelse(body_color == "R", 1, 0))
all_results <- all_results %>% mutate(handedness_bi = ifelse(handedness == "L", 1, 0))
all_results <- all_results %>% mutate(body_size0 = ifelse(body_size == "0", 1, 0))
all_results <- all_results %>% mutate(body_size1 = ifelse(body_size == "1", 1, 0))
all_results <- all_results %>% mutate(body_size2 = ifelse(body_size == "2", 1, 0))
all_results <- all_results %>% mutate(body_size3 = ifelse(body_size == "3", 1, 0))
all_results <- all_results %>% mutate(crest_heightL = ifelse(crest_height == "L", 1, 0))
all_results <- all_results %>% mutate(crest_heightM = ifelse(crest_height == "M", 1, 0))
all_results <- all_results %>% mutate(crest_heightH = ifelse(crest_height == "H", 1, 0))
all_results <- all_results %>% mutate(thumb_ratioS = ifelse(thumb_ratio == "S", 1, 0))
all_results <- all_results %>% mutate(thumb_ratioM = ifelse(thumb_ratio == "M", 1, 0))
all_results <- all_results %>% mutate(thumb_ratioL = ifelse(thumb_ratio == "L", 1, 0))
all_results <- all_results %>% mutate(pink_bi = ifelse(pink_purple == "Y", 1, 0))
all_results <- all_results %>% mutate(clear_bi = ifelse(clear == "Y", 1, 0))
all_results <- all_results %>% mutate(gap_bi = ifelse(gap == "Y", 1, 0))
all_results <- all_results %>% mutate(gono_bi = ifelse(gonodendra == "Y", 1, 0))
all_results <- all_results %>% mutate(gonodendra = ifelse(gonodendra == "Y", 1, 0))
all_results_binary <- all_results %>%
  select(body_color_Y, body_color_R, handedness_bi, body_size0, body_size1, body_size2, body_size3, crest_heightL, crest_heightM, crest_heightH, thumb_ratioS, thumb_ratioM, thumb_ratioL, pink_bi, clear_bi, gap_bi, gono_bi)
summary(all_results_binary)
```

After having some difficulty with initial trials, the non-discrete variables are removed for now.

```{r Discrete}
binary_traits <- all_results_binary %>% select(body_color_Y, body_color_R, pink_bi, gap_bi, clear_bi)
binary_traits[is.na(binary_traits)] <- 0
binary_traits_logical <- binary_traits == 1
```

The rules are then mined.

```{r Rules}
#transactions <- as(binary_traits_logical, "transactions")
rules <- apriori(binary_traits_logical, parameter = list(supp = 0.005, conf = 0.5, target = "rules"))
inspect(rules)
```


